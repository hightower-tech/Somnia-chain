# Somnia Validator Monitor Bot - Полная документация

## Содержание
1. [Обзор](#обзор)
2. [Архитектура](#архитектура)
3. [Возможности](#возможности)
4. [Установка](#установка)
5. [Конфигурация](#конфигурация)
6. [Структура проекта](#структура-проекта)
7. [Основные компоненты](#основные-компоненты)
8. [Команды бота](#команды-бота)
9. [Схема базы данных](#схема-базы-данных)
10. [Система мониторинга](#система-мониторинга)
11. [Интернационализация](#интернационализация)
12. [Обработка ошибок](#обработка-ошибок)
13. [Система логирования](#система-логирования)
14. [Система очередей](#система-очередей)
15. [Кэширование](#кэширование)
16. [Админ-панель](#админ-панель)
17. [Безопасность](#безопасность)
18. [Разработка](#разработка)
19. [Развертывание](#развертывание)
20. [Устранение неполадок](#устранение-неполадок)

## Обзор

Somnia Validator Monitor Bot - это Telegram-бот для мониторинга валидаторов в блокчейне Somnia Network. Он обеспечивает мониторинг в реальном времени, оповещения и подробную информацию о статусе валидатора, участии в комитете и стейкинге.

### Ключевые технологии
- **TypeScript** - Основной язык программирования
- **Node.js** - Среда выполнения
- **Telegraf** - Фреймворк для Telegram-ботов
- **Viem** - Библиотека для взаимодействия с Ethereum/Web3
- **SQLite** - База данных для постоянного хранения
- **Winston** - Система логирования
- **Bull** - Управление очередями (на базе Redis)
- **i18n** - Поддержка интернационализации
- **node-cache** - Кэширование в памяти

## Архитектура

Бот следует модульной архитектуре с четким разделением ответственности:

```
┌─────────────────┐     ┌──────────────┐     ┌─────────────────┐
│  Telegram API   │────▶│  Ядро бота   │────▶│  Blockchain RPC │
└─────────────────┘     └──────┬───────┘     └─────────────────┘
                               │
                    ┌──────────┴──────────┐
                    │                     │
              ┌─────▼─────┐         ┌────▼────┐
              │    БД     │         │   Кэш   │
              └───────────┘         └─────────┘
```

### Основные модули
1. **Ядро бота** (`bot.ts`) - Основная логика бота и обработчики команд
2. **Сервис блокчейна** (`blockchainService.ts`) - Взаимодействие с Somnia
3. **Сервис мониторинга** (`monitoring.ts`) - Периодический мониторинг валидаторов
4. **Слой базы данных** (`database.ts`) - Операции SQLite
5. **Конфигурация** (`config/index.ts`) - Централизованное управление конфигурацией

## Возможности

### Пользовательские возможности
- **Мониторинг валидаторов** - Отслеживание статуса в реальном времени
- **Оповещения о комитете** - Уведомления об изменениях выбора в комитет
- **Поддержка многих языков** - 5 языков (EN, RU, ZH, JA, ES)
- **Подробная статистика** - Полная информация о валидаторе
- **Управление подписками** - Простая система подписки/отписки

### Технические возможности
- **Graceful Shutdown** - Корректное завершение работы
- **Восстановление после ошибок** - Механизмы повтора с экспоненциальной задержкой
- **Система очередей** - Асинхронная обработка команд
- **Слой кэширования** - Оптимизация производительности
- **Структурированное логирование** - Детальные логи с ротацией
- **Админ-панель** - Расширенные функции управления

## Установка

### Требования
- Node.js v18+ 
- npm или yarn
- Redis (опционально, для системы очередей)
- SQLite3

### Шаги установки
```bash
# Клонировать репозиторий
git clone https://github.com/somnia-validator-bot.git
cd somnia-validator-bot

# Установить зависимости
npm install

# Скопировать пример конфигурации
cp .env.example .env

# Отредактировать .env с вашими настройками
nano .env

# Собрать проект
npm run build

# Запустить бота
npm start
```

## Конфигурация

### Переменные окружения

Бот использует переменные окружения для конфигурации. Все настройки определены в файле `.env`:

#### Конфигурация бота
- `BOT_TOKEN` - Токен Telegram-бота от @BotFather
- `TELEGRAM_ADMIN_IDS` - Список ID администраторов через запятую
- `ALLOWED_USERS_PATH` - Путь к JSON-файлу разрешенных пользователей

#### Конфигурация блокчейна
- `RPC_URL` - Эндпоинт RPC сети Somnia
- `NODE_COMMITTEE_CONTRACT_ADDRESS` - Адрес контракта комитета
- `CHAIN_ID` - ID сети Somnia (по умолчанию: 50311)

#### Конфигурация мониторинга
- `MONITORING_INTERVAL_SEC` - Интервал проверки валидаторов (по умолчанию: 300)
- `COMMITTEE_MONITORING_INTERVAL_SEC` - Интервал проверки комитета (по умолчанию: 60)

#### Конфигурация базы данных
- `DATABASE_PATH` - Путь к файлу базы данных SQLite

#### Конфигурация отображения
- `DISPLAY_STAKE_DETAILS` - Показывать информацию о стейкинге (true/false)
- `DISPLAY_REWARDS` - Показывать информацию о наградах (true/false)
- `DISPLAY_PERFORMANCE` - Показывать метрики производительности (true/false)

#### Конфигурация Redis (опционально)
- `REDIS_HOST` - Хост сервера Redis
- `REDIS_PORT` - Порт сервера Redis
- `REDIS_PASSWORD` - Пароль Redis (если требуется)

### Модуль конфигурации

Централизованная конфигурация управляется в `src/config/index.ts`:

```typescript
interface Config {
  bot: {
    token: string;
    adminIds: number[];
    allowedUsersPath: string;
  };
  blockchain: {
    rpcUrl: string;
    nodeCommitteeContract: string;
    chainId: number;
    // ... другие настройки
  };
  monitoring: {
    intervalSeconds: number;
    committeeIntervalSeconds: number;
  };
  // ... другие секции
}
```

## Структура проекта

```
somnibot/
├── src/
│   ├── config/
│   │   └── index.ts          # Централизованная конфигурация
│   ├── commands/             # Обработчики команд
│   │   ├── base.command.ts   # Базовый класс команд
│   │   ├── start.command.ts  # Команда /start
│   │   ├── help.command.ts   # Команда /help
│   │   └── ...
│   ├── services/             # Сервисы бизнес-логики
│   │   ├── queue.service.ts  # Управление очередями Bull
│   │   ├── cache.service.ts  # Слой кэширования
│   │   ├── i18n.service.ts   # Интернационализация
│   │   └── conversation.service.ts
│   ├── middleware/           # Middleware бота
│   │   └── error.middleware.ts
│   ├── utils/                # Утилиты
│   │   ├── logger.ts         # Настройка Winston
│   │   ├── retry.ts          # Логика повторов
│   │   ├── shutdown.ts       # Graceful shutdown
│   │   └── helpers.ts        # Вспомогательные функции
│   ├── bot.ts                # Главный файл бота
│   ├── blockchainService.ts  # Взаимодействие с блокчейном
│   ├── monitoring.ts         # Логика мониторинга
│   ├── database.ts           # Операции с БД
│   ├── stats.ts              # Отслеживание статистики
│   └── adminPanel.ts         # Функционал админа
├── locales/                  # Файлы переводов
│   ├── en.json
│   ├── ru.json
│   ├── zh.json
│   ├── ja.json
│   └── es.json
├── logs/                     # Файлы логов (создаются автоматически)
├── dist/                     # Скомпилированный JavaScript
├── .env                      # Переменные окружения
├── .env.example              # Пример конфигурации
├── tsconfig.json             # Конфигурация TypeScript
├── package.json              # Зависимости
└── README.md                 # Базовая документация
```

## Основные компоненты

### Ядро бота (`bot.ts`)

Главный файл бота обрабатывает:
- Регистрацию и обработку команд
- Обработку сообщений
- Callback-запросы
- Аутентификацию пользователей
- Управление состоянием

Ключевые возможности:
- Модульная система команд
- Отслеживание состояния разговора
- Разделение админских команд
- Многоязычные описания команд

### Сервис блокчейна (`blockchainService.ts`)

Взаимодействует с блокчейном Somnia:
- Получение данных валидатора
- Проверка статуса комитета
- Взаимодействие с контрактами
- Мониторинг событий

Ключевые функции:
```typescript
getValidatorData(address: string): Promise<ValidatorDetails>
getCommitteeStatus(address: string): Promise<CommitteeInfo>
getStakeDetails(validatorId: bigint): Promise<StakeInfo>
```

### Сервис мониторинга (`monitoring.ts`)

Обрабатывает периодические проверки:
- Мониторинг статуса валидаторов
- Отслеживание участия в комитете
- Генерация оповещений
- Обновление базы данных

Возможности:
- Раздельные интервалы для разных проверок
- Эффективная пакетная обработка
- Восстановление после ошибок
- Поддержка graceful shutdown

### Слой базы данных (`database.ts`)

Управление базой данных SQLite:
- Подписки пользователей
- Состояния валидаторов
- История оповещений
- Статистика

Ключевые таблицы:
- `subscriptions` - Связи пользователь-валидатор
- `validator_states` - Кэшированные данные валидаторов
- `bot_metrics` - Статистика использования

## Команды бота

### Пользовательские команды

#### `/start`
- Показывает приветственное сообщение
- Отображает возможности бота
- Доступна на всех языках

#### `/subscribe`
- Подписаться на мониторинг валидатора
- Синтаксис: `/subscribe` затем отправить адрес валидатора
- Валидирует Ethereum-адреса
- Предотвращает дублирование подписок

#### `/unsubscribe`
- Отписаться от валидатора
- Синтаксис: `/unsubscribe` затем отправить адрес валидатора
- Подтверждает удаление

#### `/status`
- Просмотр всех активных подписок
- Показывает детали валидатора:
  - Статус в комитете (текущая/следующая эпоха)
  - Моникер и комиссия
  - Общий стейк и делегаторы
  - Метрики производительности
  - Информация о наградах

#### `/language`
- Изменить язык интерфейса бота
- Поддерживается: английский, русский, китайский, японский, испанский
- Сохраняет предпочтение пользователя

#### `/help`
- Показывает справку по командам
- Админы видят админ-панель

### Админские команды

Доступны через `/help` для администраторов:

#### Управление пользователями
- Просмотр всех пользователей бота
- Поиск пользователей по ID
- Отправка сообщений пользователям
- Просмотр статистики пользователей

#### Управление мониторингом
- Принудительное обновление валидаторов
- Просмотр статуса мониторинга
- Проверка логов ошибок

#### Системная информация
- Статистика бота
- Метрики базы данных
- Данные производительности
- Статус RPC-эндпоинта

## Схема базы данных

### Таблицы

#### `subscriptions`
```sql
CREATE TABLE subscriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,
    node_address TEXT NOT NULL,
    network TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(chat_id, node_address)
);
```

#### `validator_states`
```sql
CREATE TABLE validator_states (
    node_address TEXT PRIMARY KEY,
    data TEXT NOT NULL,
    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### `bot_metrics`
```sql
CREATE TABLE bot_metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    total_users INTEGER DEFAULT 0,
    total_commands INTEGER DEFAULT 0,
    total_subscriptions INTEGER DEFAULT 0,
    total_api_calls INTEGER DEFAULT 0,
    uptime_seconds INTEGER DEFAULT 0,
    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## Система мониторинга

### Мониторинг валидаторов
- Запускается каждые 5 минут (настраивается)
- Проверяет всех подписанных валидаторов
- Обновляет кэш базы данных
- Генерирует оповещения об изменениях

### Мониторинг комитета
- Запускается каждые 60 секунд (настраивается)
- Отслеживает участие в комитете
- Отправляет немедленные оповещения об изменениях
- Отделен от основного мониторинга для быстрого отклика

### Типы оповещений
1. **Выбор в комитет** - Валидатор выбран/удален из комитета
2. **Изменения статуса** - Переходы активный/неактивный
3. **Оповещения о производительности** - Значительные изменения метрик

## Интернационализация

### Поддерживаемые языки
- Английский (en)
- Русский (ru) 
- Китайский (zh)
- Японский (ja)
- Испанский (es)

### Реализация
- Использует библиотеку `i18n`
- Переводы на основе JSON
- Хранение предпочтений пользователя
- Откат на английский

### Структура переводов
```json
{
  "welcome": {
    "title": "Приветственное сообщение",
    "description": "Описание бота"
  },
  "commands": {
    "subscribe": {
      "prompt": "Отправьте адрес валидатора",
      "success": "Успешно подписались"
    }
  }
}
```

## Обработка ошибок

### Механизм повторов
- Экспоненциальная задержка для неудачных запросов
- Настраиваемое количество попыток
- Максимальные ограничения задержки
- Поддержка декораторов

### Middleware обработки ошибок
- Перехватывает все ошибки бота
- Логирует с уникальными ID ошибок
- Дружественные сообщения об ошибках
- Предотвращает падение бота

### Типы ошибок
1. **Сетевые ошибки** - Таймауты RPC, проблемы соединения
2. **Ошибки валидации** - Неверные адреса, данные
3. **Ошибки базы данных** - Проблемы SQLite
4. **Ошибки Telegram API** - Лимиты скорости, сеть

## Система логирования

### Конфигурация Winston
- Вывод в консоль с цветами
- Ежедневная ротация файлов логов
- Отдельные логи ошибок
- Настраиваемые уровни логирования

### Файлы логов
- `logs/combined-YYYY-MM-DD.log` - Все логи
- `logs/error-YYYY-MM-DD.log` - Только ошибки
- Автоматическая ротация и очистка
- Ограничения максимального размера файла

### Дочерние логгеры
- `blockchain` - Операции блокчейна
- `monitoring` - Действия мониторинга
- `database` - Операции базы данных
- `queue` - Обработка очередей

## Система очередей

### Очереди Bull
- Очередь обработки команд
- Очередь уведомлений
- Персистентность на базе Redis
- Автоматические повторы

### Возможности очередей
- Поддержка приоритетов
- Отложенные задачи
- Ограничение скорости
- Обработка неудачных задач
- Поддержка дашборда

### Конфигурация
```javascript
{
  removeOnComplete: 100,  // Хранить последние 100 выполненных
  removeOnFail: 50,       // Хранить последние 50 неудачных
  attempts: 3,            // Повторить 3 раза
  backoff: {
    type: 'exponential',
    delay: 2000           // Начать с задержки 2с
  }
}
```

## Кэширование

### Слои кэша
1. **Кэш валидаторов** - TTL 5 минут
2. **Кэш комитета** - TTL 30 секунд
3. **Кэш статистики** - TTL 1 час

### Сервис кэширования
- Автоматическое истечение
- Эффективное использование памяти
- Отслеживание попаданий/промахов
- Поддержка декораторов

### Использование
```typescript
@Cacheable('validator', (address) => address)
async getValidatorData(address: string) {
  // Автоматически кэшируется
}
```

## Админ-панель

### Возможности
- Управление пользователями
- Системная статистика
- Прямые сообщения
- Управление мониторингом
- Метрики производительности

### Контроль доступа
- ID админов в окружении
- Безопасная обработка команд
- Логирование активности

### Админские процессы
1. **Поиск пользователей** - Найти пользователей по ID
2. **Рассылка** - Сообщение всем пользователям
3. **Статистика** - Просмотр метрик бота
4. **Обслуживание** - Системные контроли

## Безопасность

### Контроль доступа
- Валидация ID пользователей Telegram
- Команды только для админов
- Список разрешенных пользователей (опционально)

### Защита данных
- Переменные окружения для секретов
- Нет чувствительных данных в логах
- Безопасные RPC-соединения

### Лучшие практики
- Валидация ввода
- Предотвращение SQL-инъекций
- Ограничение скорости
- Санитизация сообщений об ошибках

## Разработка

### Настройка среды разработки
```bash
# Установить зависимости
npm install

# Настроить pre-commit хуки
npm run prepare

# Запустить в режиме разработки
npm run dev
```

### Стиль кода
- Строгий режим TypeScript
- Конфигурация ESLint
- Форматирование Prettier
- Согласованные соглашения об именовании

### Тестирование
```bash
# Запустить тесты
npm test

# Запустить с покрытием
npm run test:coverage
```

### Сборка
```bash
# Сборка для продакшена
npm run build

# Чистая сборка
rm -rf dist && npm run build
```

## Развертывание

### Чеклист для продакшена
1. Установить переменные окружения продакшена
2. Настроить правильные RPC-эндпоинты
3. Настроить Redis (опционально)
4. Настроить ротацию логов
5. Настроить менеджер процессов (PM2)
6. Настроить мониторинг
7. Настроить резервное копирование

### Конфигурация PM2
```javascript
module.exports = {
  apps: [{
    name: 'somnia-bot',
    script: './dist/bot.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

### Поддержка Docker
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build
CMD ["node", "dist/bot.js"]
```

## Устранение неполадок

### Частые проблемы

#### Бот не запускается
- Проверьте валидность BOT_TOKEN
- Проверьте права доступа к базе данных
- Проверьте файлы логов на ошибки

#### Нет данных блокчейна
- Проверьте доступность RPC_URL
- Проверьте адреса контрактов
- Мониторьте лимиты RPC

#### Ошибки базы данных
- Проверьте права доступа к файлам
- Проверьте свободное место на диске
- Запустите проверку целостности БД

#### Ошибка подключения к Redis
- Redis опционален
- Проверьте REDIS_HOST и REDIS_PORT
- Убедитесь что Redis запущен

### Режим отладки
Установите переменные окружения:
```bash
NODE_ENV=development
LOG_LEVEL=debug
```

### Проверки здоровья
- Эндпоинт `/health` (если включен)
- Метрики мониторинга
- Анализ файлов логов
- Запросы к базе данных

### Оптимизация производительности
1. Включить кэширование
2. Оптимизировать запросы к БД
3. Использовать систему очередей
4. Мониторить использование памяти
5. Настроить правильные индексы

## Обслуживание

### Регулярные задачи
1. **Ротация логов** - Автоматически с Winston
2. **Очистка БД** - Удаление старых состояний
3. **Оптимизация кэша** - Мониторинг коэффициента попаданий
4. **Обзор производительности** - Проверка метрик

### Стратегия резервного копирования
- Ежедневное резервное копирование БД
- Резервное копирование конфигурации
- Архивирование логов
- План аварийного восстановления

### Мониторинг
- Мониторинг аптайма
- Отслеживание частоты ошибок
- Метрики производительности
- Анализ активности пользователей

## Справочник API

### API сервиса блокчейна

#### `getValidatorData(address: string)`
Возвращает полную информацию о валидаторе включая стейк, производительность и награды.

#### `getCommitteeStatus(address: string)`
Возвращает статус участия в комитете текущей и следующей эпохи.

#### `checkIsNodeActive(address: string)`
Простая булева проверка активного статуса валидатора.

### API базы данных

#### `subscribeUser(chatId, address, network)`
Создает новую подписку для пользователя.

#### `unsubscribeUser(chatId, address)`
Удаляет подписку пользователя.

#### `getSubscriptionsByChatId(chatId)`
Возвращает все подписки пользователя.

#### `saveValidatorState(address, data)`
Кэширует данные валидатора в базе данных.

### Расширения контекста бота

Бот расширяет контекст Telegraf с:
- `ctx.i18n` - Функции интернационализации
- `ctx.session` - Данные сессии пользователя
- Пользовательские дополнения middleware

## Участие в разработке

### Руководящие принципы
1. Следуйте лучшим практикам TypeScript
2. Добавляйте соответствующее логирование
3. Обновляйте документацию
4. Тщательно тестируйте
5. Отправляйте pull requests

### Процесс код-ревью
1. Автоматические проверки (линтинг, типы)
2. Ручное ревью кода
3. Проверка тестирования
4. Обновления документации

## Лицензия

Этот проект лицензирован под лицензией MIT. См. файл LICENSE для деталей.

## Поддержка

По вопросам и проблемам:
1. Проверьте документацию
2. Просмотрите логи
3. Поищите существующие issues
4. Создайте новый issue с деталями

---

Создано с ❤️ компанией [htw.tech](https://www.htw.tech/)
